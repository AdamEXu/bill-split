{% extends "base.html" %}

{% block title %}Create Bill - {{ group.name }} - Bill Split{% endblock %}

{% block content %}
<div class="form-page">
    <div class="form-container" style="max-width: 800px;">
        <h1 class="form-title md-headline-medium">
            <span class="material-icons md-24">receipt_long</span>
            Create New Bill for {{ group.name }}
        </h1>

        {% if error %}
        <div class="md-alert md-alert--error">
            <span class="material-icons md-18">error</span>
            {{ error }}
        </div>
        {% endif %}

        <!-- Tab Navigation -->
        <div class="md-tabs">
            <div class="md-tabs__list">
                <button type="button" class="md-tab md-tab--active" onclick="switchTab('ai-entry')">
                    <span class="material-icons md-18">smart_toy</span>
                    AI Entry
                </button>
                <button type="button" class="md-tab" onclick="switchTab('manual-entry')">
                    <span class="material-icons md-18">edit</span>
                    Manual Entry
                </button>
            </div>
        </div>

        <!-- AI Entry Tab -->
        <div id="ai-entry" class="md-tab-content md-tab-content--active">
            <div class="md-card md-mt-lg">
                <h3 class="md-title-large md-mb-md">
                    <span class="material-icons md-24">smart_toy</span>
                    Upload Receipt for AI Processing
                </h3>
                <p class="md-body-large md-mb-lg">
                    Upload a receipt image and let AI automatically extract all the details for you!
                </p>

                <div class="upload-area md-card md-card--outlined md-text-center md-p-xl" style="border: 2px dashed var(--md-outline); cursor: pointer;">
                    <input type="file" id="ai_receipt_image" accept="image/*" onchange="handleAIReceiptUpload(this)" style="display: none;" />
                    <label for="ai_receipt_image" style="cursor: pointer; display: block;">
                        <span class="material-icons md-48 md-text-primary md-mb-md">cloud_upload</span>
                        <div class="md-title-medium md-mb-sm">Choose Receipt Image</div>
                        <div class="md-body-medium md-text-on-surface-variant">Drag and drop or click to select</div>
                    </label>
                </div>

                <div id="ai_status" class="md-mt-lg" style="display: none;">
                    <div id="ai_loading" class="md-alert md-alert--info md-text-center" style="display: none;">
                        <div class="md-flex md-flex--center md-flex--align-center md-mb-sm">
                            <div class="md-spinner md-mr-sm"></div>
                            <span class="material-icons md-24">smart_toy</span>
                        </div>
                        <div class="md-title-medium">AI is analyzing your receipt...</div>
                        <div class="md-body-small">This may take a few seconds</div>
                    </div>
                    <div id="ai_success" class="md-alert md-alert--success md-text-center" style="display: none;">
                        <span class="material-icons md-24 md-mb-sm">check_circle</span>
                        <div class="md-title-medium">Receipt processed successfully!</div>
                        <div class="md-body-small">Switching to manual entry for review...</div>
                    </div>
                    <div id="ai_error" class="md-alert md-alert--error md-text-center" style="display: none;">
                        <span class="material-icons md-24 md-mb-sm">error</span>
                        <div class="md-title-medium"><span id="ai_error_message"></span></div>
                        <div class="md-body-small">Please try again or switch to manual entry</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Entry Tab -->
        <div id="manual-entry" class="md-tab-content">
            <form method="POST">
                <div class="md-form-field">
                    <label for="title" class="md-form-field__label md-form-field__label--required">Bill Title</label>
                    <input type="text" id="title" name="title" class="md-text-field" required />
                </div>

                <div class="md-form-field">
                    <label for="description" class="md-form-field__label">Description</label>
                    <textarea id="description" name="description" rows="3" class="md-text-field"></textarea>
                </div>

                <div class="md-grid md-grid--2-col">
                    <div class="md-form-field">
                        <label for="subtotal" class="md-form-field__label md-form-field__label--required">Subtotal ($)</label>
                        <input type="number" id="subtotal" name="subtotal" step="0.01" min="0" class="md-text-field" required />
                    </div>

                    <div class="md-form-field">
                        <label for="tax_amount" class="md-form-field__label">Tax Amount ($)</label>
                        <input type="number" id="tax_amount" name="tax_amount" step="0.01" min="0" value="0" class="md-text-field" />
                    </div>

                    <div class="md-form-field">
                        <label for="tip_amount" class="md-form-field__label">Tip Amount ($)</label>
                        <input type="number" id="tip_amount" name="tip_amount" step="0.01" min="0" value="0" class="md-text-field" />
                    </div>
                </div>

                <div class="md-form-field">
                    <label for="paid_by" class="md-form-field__label md-form-field__label--required">Who Paid the Bill?</label>
                    <select id="paid_by" name="paid_by" class="md-select" required>
                        <option value="">Select who paid...</option>
                        {% for member in members %}
                        <option value="{{ member.id }}">{{ member.name }}</option>
                        {% endfor %}
                    </select>
                    <small class="md-body-small md-text-on-surface-variant md-mt-xs">
                        This person will be owed money by the other participants
                    </small>
                </div>

                <div class="md-form-field">
                    <label for="split_method" class="md-form-field__label">Split Method</label>
                    <select id="split_method" name="split_method" class="md-select" onchange="toggleSplitOptions()">
                        <option value="equal">Split Equally</option>
                        <option value="itemized">Itemized (by items)</option>
                        <option value="percentage">By Percentage</option>
                        <option value="custom">Custom Amounts</option>
                    </select>
                </div>

        <div id="items_section" style="display: none">
            <h4>Items</h4>
            <div id="items_container">
                <div class="item-row">
                    <input
                        type="text"
                        name="item_name"
                        placeholder="Item name"
                        style="width: 30%"
                    />
                    <input
                        type="number"
                        name="item_price"
                        placeholder="Price"
                        step="0.01"
                        min="0"
                        style="width: 20%"
                    />
                    <input
                        type="number"
                        name="item_quantity"
                        placeholder="Qty"
                        min="1"
                        value="1"
                        style="width: 15%"
                    />
                    <label
                        ><input type="checkbox" name="item_shared" value="0" />
                        Shared</label
                    >
                </div>
            </div>
            <button type="button" onclick="addItem()">Add Another Item</button>
        </div>

        <div class="form-group">
            <label>Participants *</label>
            {% for member in members %}
            <div class="participant-row">
                <input
                    type="checkbox"
                    id="participant_{{ member.id }}"
                    name="participants"
                    value="{{ member.id }}"
                    onchange="updateSplitOptions()"
                />
                <label for="participant_{{ member.id }}"
                    >{{ member.name }}</label
                >

                <div
                    id="percentage_{{ member.id }}"
                    class="split-option"
                    style="display: none"
                >
                    <input
                        type="number"
                        name="percentage_{{ member.id }}"
                        placeholder="%"
                        min="0"
                        max="100"
                        step="0.01"
                    />
                </div>

                <div
                    id="custom_{{ member.id }}"
                    class="split-option"
                    style="display: none"
                >
                    <input
                        type="number"
                        name="custom_amount_{{ member.id }}"
                        placeholder="$"
                        min="0"
                        step="0.01"
                    />
                </div>
            </div>
            {% endfor %}
        </div>

        <button type="submit" class="btn">Create Bill</button>
        <a href="/groups/{{ group.id }}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<style>
/* Tab Styles */
.tab-container {
    margin-bottom: 20px;
}

.tab-buttons {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 20px;
}

.tab-button {
    background: none;
    border: none;
    padding: 12px 24px;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
}

.tab-button:hover {
    background-color: #f5f5f5;
}

.tab-button.active {
    border-bottom-color: #007bff;
    color: #007bff;
    font-weight: bold;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* AI Upload Styles */
.ai-upload-section {
    text-align: center;
    padding: 40px 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
}

.upload-area {
    margin: 30px 0;
}

.upload-area input[type="file"] {
    display: none;
}

.upload-label {
    display: inline-block;
    padding: 15px 30px;
    background: #007bff;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    transition: background-color 0.3s ease;
}

.upload-label:hover {
    background: #0056b3;
}

/* Spinner Animation */
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

    <script>
        let itemCount = 1;

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // AI Receipt Upload Handler
        function handleAIReceiptUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Show loading state
            showAIStatus('loading');

            // Create FormData to send the file
            const formData = new FormData();
            formData.append('receipt_image', file);

            // Send to backend for processing
            fetch('/api/parse-receipt', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate form fields with parsed data
                    populateFormFromReceipt(data.data);
                    showAIStatus('success');

                    // Auto-switch to manual entry after 2 seconds
                    setTimeout(() => {
                        switchTab('manual-entry');
                        document.querySelector('[onclick="switchTab(\'manual-entry\')"]').classList.add('active');
                        document.querySelector('[onclick="switchTab(\'ai-entry\')"]').classList.remove('active');
                    }, 2000);
                } else {
                    showAIStatus('error', data.error || 'Failed to process receipt');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAIStatus('error', 'Network error occurred while processing receipt');
            });
        }

        function showAIStatus(type, message = '') {
            const statusDiv = document.getElementById('ai_status');
            const loadingDiv = document.getElementById('ai_loading');
            const successDiv = document.getElementById('ai_success');
            const errorDiv = document.getElementById('ai_error');
            const errorMessage = document.getElementById('ai_error_message');

            // Hide all status divs first
            loadingDiv.style.display = 'none';
            successDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            // Show the appropriate status
            statusDiv.style.display = 'block';

            if (type === 'loading') {
                loadingDiv.style.display = 'block';
            } else if (type === 'success') {
                successDiv.style.display = 'block';
            } else if (type === 'error') {
                errorDiv.style.display = 'block';
                errorMessage.textContent = message;
            }
        }

        // Legacy function for old receipt upload (now unused)
        function handleReceiptUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Show loading state
            showReceiptStatus("loading");

            // Create FormData to send the file
            const formData = new FormData();
            formData.append("receipt_image", file);

            // Send to backend for processing
            fetch("/api/parse-receipt", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Populate form fields with parsed data
                        populateFormFromReceipt(data.data);
                        showReceiptStatus("success");
                    } else {
                        showReceiptStatus(
                            "error",
                            data.error || "Failed to process receipt"
                        );
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    showReceiptStatus(
                        "error",
                        "Network error occurred while processing receipt"
                    );
                });
        }

        function showReceiptStatus(type, message = "") {
            const statusDiv = document.getElementById("receipt_status");
            const loadingDiv = document.getElementById("receipt_loading");
            const successDiv = document.getElementById("receipt_success");
            const errorDiv = document.getElementById("receipt_error");
            const errorMessage = document.getElementById(
                "receipt_error_message"
            );

            // Hide all status divs first
            loadingDiv.style.display = "none";
            successDiv.style.display = "none";
            errorDiv.style.display = "none";

            // Show the appropriate status
            statusDiv.style.display = "block";

            if (type === "loading") {
                loadingDiv.style.display = "block";
            } else if (type === "success") {
                successDiv.style.display = "block";
            } else if (type === "error") {
                errorDiv.style.display = "block";
                errorMessage.textContent = message;
            }
        }

        function populateFormFromReceipt(data) {
            // Populate basic fields
            if (data.title) {
                document.getElementById("title").value = data.title;
            }

            if (data.description) {
                document.getElementById("description").value = data.description;
            }

            if (data.subtotal) {
                document.getElementById("subtotal").value =
                    data.subtotal.toFixed(2);
            }

            if (data.tax_amount) {
                document.getElementById("tax_amount").value =
                    data.tax_amount.toFixed(2);
            }

            if (data.tip_amount) {
                document.getElementById("tip_amount").value =
                    data.tip_amount.toFixed(2);
            }

            // If items are present, switch to itemized split and populate items
            if (data.items && data.items.length > 0) {
                document.getElementById("split_method").value = "itemized";
                toggleSplitOptions(); // Show items section

                // Clear existing items
                const container = document.getElementById("items_container");
                container.innerHTML = "";

                // Add each item
                data.items.forEach((item, index) => {
                    if (index === 0) {
                        // Use the first item row that already exists
                        const firstRow = document.createElement("div");
                        firstRow.className = "item-row";
                        firstRow.innerHTML = `
                        <input type="text" name="item_name" placeholder="Item name" style="width: 30%;" value="${
                            item.name
                        }">
                        <input type="number" name="item_price" placeholder="Price" step="0.01" min="0" style="width: 20%;" value="${item.price.toFixed(
                            2
                        )}">
                        <input type="number" name="item_quantity" placeholder="Qty" min="1" value="${
                            item.quantity
                        }" style="width: 15%;">
                        <label><input type="checkbox" name="item_shared" value="0"> Shared</label>
                    `;
                        container.appendChild(firstRow);
                    } else {
                        // Add additional items
                        const newItem = document.createElement("div");
                        newItem.className = "item-row";
                        newItem.innerHTML = `
                        <input type="text" name="item_name" placeholder="Item name" style="width: 30%;" value="${
                            item.name
                        }">
                        <input type="number" name="item_price" placeholder="Price" step="0.01" min="0" style="width: 20%;" value="${item.price.toFixed(
                            2
                        )}">
                        <input type="number" name="item_quantity" placeholder="Qty" min="1" value="${
                            item.quantity
                        }" style="width: 15%;">
                        <label><input type="checkbox" name="item_shared" value="${index}"> Shared</label>
                        <button type="button" onclick="removeItem(this)">Remove</button>
                    `;
                        container.appendChild(newItem);
                    }
                });

                itemCount = data.items.length;
            }

            // Update total calculation
            updateTotal();
        }

        function toggleSplitOptions() {
            const splitMethod = document.getElementById("split_method").value;
            const itemsSection = document.getElementById("items_section");

            // Hide all split options first
            document
                .querySelectorAll(".split-option")
                .forEach((el) => (el.style.display = "none"));

            if (splitMethod === "itemized") {
                itemsSection.style.display = "block";
            } else {
                itemsSection.style.display = "none";
            }

            if (splitMethod === "percentage") {
                document
                    .querySelectorAll('[id^="percentage_"]')
                    .forEach((el) => (el.style.display = "inline-block"));
            } else if (splitMethod === "custom") {
                document
                    .querySelectorAll('[id^="custom_"]')
                    .forEach((el) => (el.style.display = "inline-block"));
            }
        }

        function addItem() {
            const container = document.getElementById("items_container");
            const newItem = document.createElement("div");
            newItem.className = "item-row";
            newItem.innerHTML = `
        <input type="text" name="item_name" placeholder="Item name" style="width: 30%;">
        <input type="number" name="item_price" placeholder="Price" step="0.01" min="0" style="width: 20%;">
        <input type="number" name="item_quantity" placeholder="Qty" min="1" value="1" style="width: 15%;">
        <label><input type="checkbox" name="item_shared" value="${itemCount}"> Shared</label>
        <button type="button" onclick="removeItem(this)">Remove</button>
    `;
            container.appendChild(newItem);
            itemCount++;
        }

        function removeItem(button) {
            button.parentElement.remove();
        }

        function updateSplitOptions() {
            // This function can be used to update split options when participants change
            // For now, it's just a placeholder
        }

        // Calculate total amount automatically
        function updateTotal() {
            const subtotal =
                parseFloat(document.getElementById("subtotal").value) || 0;
            const tax =
                parseFloat(document.getElementById("tax_amount").value) || 0;
            const tip =
                parseFloat(document.getElementById("tip_amount").value) || 0;
            const total = subtotal + tax + tip;

            // You could display this total somewhere if needed
            console.log("Total:", total);
        }

        document
            .getElementById("subtotal")
            .addEventListener("input", updateTotal);
        document
            .getElementById("tax_amount")
            .addEventListener("input", updateTotal);
        document
            .getElementById("tip_amount")
            .addEventListener("input", updateTotal);
    </script>
    {% endblock %}
</div>
