{% extends "base.html" %}

{% block title %}{{ group.name }} - Bill Split{% endblock %}

{% block content %}
<div class="group-page">
    <div class="group-header">
        <div class="group-header__top">
            <div class="group-header__info">
                <h1 class="md-headline-large">{{ group.name }}</h1>
                {% if group.description %}
                <p class="group-header__description">{{ group.description }}</p>
                {% endif %}
            </div>
            <a href="/groups/{{ group.id }}/bills/create" class="md-button md-button--filled">
                <span class="material-icons md-18">add</span>
                Add New Bill
            </a>
        </div>
    </div>

    <div class="group-content">
        <div class="members-section">
            <h3 class="section-title">
                <span class="material-icons md-24">group</span>
                Members
            </h3>
            {% for member in members %}
            <div class="member-item">
                {% if member.profile_picture %}
                <img src="{{ member.profile_picture }}" alt="{{ member.name }}" class="member-avatar">
                {% else %}
                <div class="member-avatar">{{ member.name[0].upper() }}</div>
                {% endif %}
                <span class="member-name">{{ member.name }}</span>
            </div>
            {% endfor %}

            <div class="add-member-form">
                <h4 class="md-title-medium md-mb-md">
                    <span class="material-icons md-18">person_add</span>
                    Add Member
                </h4>
                <form id="add-member-form">
                    <div class="md-form-field">
                        <input
                            type="email"
                            name="email"
                            placeholder="Enter email address"
                            class="md-text-field"
                            required
                        />
                    </div>
                    <button type="submit" class="md-button md-button--filled md-button--small">
                        <span class="material-icons md-18">add</span>
                        Add Member
                    </button>
                </form>
                <div id="add-member-result"></div>
            </div>
        </div>

        <div class="bills-section">
            <h3 class="section-title">
                <span class="material-icons md-24">receipt_long</span>
                Bills
            </h3>
            {% if bills %}
                {% for bill in bills %}
                <div class="bill-item">
                    <div class="bill-item__header">
                        <a href="/bills/{{ bill.id }}" class="bill-item__title">{{ bill.title }}</a>
                        <span class="bill-item__amount">${{ "%.2f"|format(bill.total_amount) }}</span>
                    </div>
                    {% if bill.description %}
                    <p class="bill-item__description">{{ bill.description }}</p>
                    {% endif %}
                    <div class="bill-item__meta">
                        <span class="material-icons md-18">schedule</span>
                        Created {{ bill.created_at.strftime('%B %d, %Y') }}
                    </div>
                    <div class="md-flex md-flex--end md-mt-md" style="gap: var(--md-spacing-sm);">
                        <a href="/groups/{{ group.id }}/bills/{{ bill.id }}/edit" class="md-button md-button--outlined md-button--small">
                            <span class="material-icons md-18">edit</span>
                            Edit
                        </a>
                        <form method="POST" action="/groups/{{ group.id }}/bills/{{ bill.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this bill? This action cannot be undone.');">
                            <button type="submit" class="md-button md-button--outlined md-button--small md-button--error">
                                <span class="material-icons md-18">delete</span>
                                Delete
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-state__icon">
                        <span class="material-icons">receipt_long</span>
                    </div>
                    <h4 class="empty-state__title">No bills yet</h4>
                    <p class="empty-state__description">
                        <a href="/groups/{{ group.id }}/bills/create" class="md-button md-button--text">
                            Create the first bill!
                        </a>
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document
        .getElementById("add-member-form")
        .addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/groups/{{ group.id }}/add_member", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    const resultDiv =
                        document.getElementById("add-member-result");
                    if (data.success) {
                        resultDiv.innerHTML =
                            '<div class="md-alert md-alert--success">' + data.message + "</div>";
                        this.reset();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        resultDiv.innerHTML =
                            '<div class="md-alert md-alert--error">' + data.error + "</div>";
                    }
                })
                .catch((error) => {
                    document.getElementById("add-member-result").innerHTML =
                        '<div class="md-alert md-alert--error">An error occurred</div>';
                });
        });
</script>
{% endblock %}
